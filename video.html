<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="fluiditypeer.js"></script>
		<script src="peerjs.min.js"></script>
	</head>
	<body>
		<main style="display: none">
			<p id="id">FluidityPeer ID: </p>
			<input id="conn_id" placeholder="FluidityPeer ID" /><button onclick="callUser()" id="conn_id_btn">Call</button><br>
			<video id="video_self" autoplay style="display: none; width: calc(50% - 10px);"></video>
			<video id="video" autoplay style="display: none; width: calc(50% - 10px);"></video>
		</main>
		<script>
			async function init() {
				window.peer = await new FluidityPeer();
				console.log("FluidityPeer ID: " + peer.id);
				peer.onReceive = (data, conn_id, peer_id) => {
					
				}
				var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
				peer.peer.on('call', function(call) {
					getUserMedia({video: true, audio: true}, function(stream) {
						call.answer(stream);
						call.on('stream', function(remoteStream) {
							document.querySelector("#conn_id").style.display = "none";
							document.querySelector("#conn_id_btn").style.display = "none";
							document.querySelector("#video").srcObject = remoteStream;
							document.querySelector("#video").style.display = "inline-block";
							getUserMedia({video: true, audio: false}, function(myStream) {
								document.querySelector("#video_self").srcObject = myStream;
								document.querySelector("#video_self").style.display = "inline-block";
							});
						});
					}, function(err) {
						console.log('Failed to get local stream' ,err);
					});
				});
				document.querySelector("#id").innerHTML = "FluidityPeer ID: " + peer.id;
				document.querySelector("main").style.display = "block";
			}
			
			async function callUser() {
				let peer_id = document.querySelector("#conn_id").value;
				document.querySelector("#conn_id").value = "";
				
				var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
				getUserMedia({video: true, audio: true}, function(stream) {
					var call = peer.peer.call(peer_id, stream);
					call.on('stream', function(remoteStream) {
						document.querySelector("#conn_id").style.display = "none";
						document.querySelector("#conn_id_btn").style.display = "none";
						document.querySelector("#video").srcObject = remoteStream;
						document.querySelector("#video").style.display = "inline-block";
						getUserMedia({video: true, audio: false}, function(myStream) {
							document.querySelector("#video_self").srcObject = myStream;
							document.querySelector("#video_self").style.display = "inline-block";
						});
					});
				}, function(err) {
					console.log('Failed to get local stream' ,err);
				});
			}	
			
			init();
		</script>
	</body>
</html>